<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapy Session - {{ user.full_name }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Same CSS as before (unchanged for brevity) --- */
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;}
        .container{max-width:1400px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);overflow:hidden;}
        header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px 30px;display:flex;justify-content:space-between;align-items:center;}
        header h1{font-size:1.8em;}
        .user-info{display:flex;align-items:center;gap:15px;}
        .btn-logout{background:rgba(255,255,255,0.2);color:white;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;text-decoration:none;font-size:14px;}
        .btn-logout:hover{background:rgba(255,255,255,0.3);}
        .main-content{display:grid;grid-template-columns:2fr 1fr;gap:20px;padding:30px;}
        .video-section{background:#f8f9fa;border-radius:10px;padding:20px;}
        .video-section h2{color:#667eea;margin-bottom:15px;}
        #video-feed{width:100%;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);background:#000;}
        .controls{margin-top:20px;display:flex;gap:15px;flex-wrap:wrap;}
        .btn{padding:14px 28px;border:none;border-radius:10px;font-size:16px;cursor:pointer;transition:all 0.3s;font-weight:600;display:flex;align-items:center;gap:8px;}
        .btn-start{background:#10b981;color:white;flex:1;}
        .btn-start:hover{background:#059669;transform:translateY(-2px);}
        .btn-stop{background:#ef4444;color:white;flex:1;}
        .btn-stop:hover{background:#dc2626;transform:translateY(-2px);}
        .btn-history{background:#667eea;color:white;}
        .btn-history:hover{background:#5568d3;}
        .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important;}
        .stats-section{display:flex;flex-direction:column;gap:20px;}
        .card{background:#f8f9fa;border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
        .card h3{color:#667eea;margin-bottom:15px;font-size:1.2em;}
        .status-indicator{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;font-size:0.9em;font-weight:600;margin-left:10px;}
        .status-indicator.recording{background:#fee2e2;color:#dc2626;}
        .status-indicator.stopped{background:#e5e7eb;color:#6b7280;}
        .status-dot{width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 2s infinite;}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.3;}}
        .emotion-display{text-align:center;padding:20px;background:white;border-radius:8px;}
        .emotion-text{font-size:2.5em;font-weight:bold;color:#667eea;margin:10px 0;}
        .confidence{font-size:1.2em;color:#6b7280;}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
        .stat-item{background:white;padding:15px;border-radius:8px;text-align:center;}
        .stat-item .label{font-size:0.9em;color:#6b7280;margin-bottom:5px;}
        .stat-item .value{font-size:1.8em;font-weight:bold;color:#667eea;}
        #emotionChart{max-height:300px;}
        .alert{padding:15px;border-radius:8px;margin-bottom:20px;display:none;}
        .alert-success{background:#d1fae5;color:#065f46;border:1px solid #10b981;}
        .alert-info{background:#dbeafe;color:#1e40af;border:1px solid #3b82f6;}
        @media(max-width:968px){.main-content{grid-template-columns:1fr;}}
    </style>
</head>
<body>
<div class="container">
    <header>
        <div>
            <h1>üß† Therapy Session</h1>
            <small style="opacity: 0.9;">Real-time Emotion Monitoring</small>
        </div>
        <div class="user-info">
            <span>Welcome, {{ user.full_name }}</span>
            <a href="/my_sessions" class="btn-logout">üìä My History</a>
            <a href="/logout" class="btn-logout">Logout</a>
        </div>
    </header>

    <div class="main-content">
        <div class="video-section">
            <div id="alert-container"></div>

            <h2>Live Video Feed</h2>
            <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Video Feed">

            <div class="controls">
                <button class="btn btn-start" id="start-btn" onclick="startSession()">‚ñ∂Ô∏è Start Session</button>
                <button class="btn btn-stop" id="stop-btn" onclick="stopSession()" disabled>‚èπÔ∏è Stop Session</button>
            </div>

            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                <p style="color: #6b7280; font-size: 0.95em;">
                    üí° <strong>How it works:</strong> Click "Start Session" to begin monitoring your emotions. 
                    The system will detect and analyze your facial expressions in real-time. 
                    When finished, click "Stop Session" to generate an AI summary.
                </p>
            </div>
        </div>

        <div class="stats-section">
            <div class="card">
                <h3>
                    Session Status
                    <span id="status-indicator" class="status-indicator stopped">
                        <span class="status-dot"></span> Not Recording
                    </span>
                </h3>
                <div class="emotion-display">
                    <div class="label" style="color: #6b7280; font-size: 0.9em;">Current Emotion</div>
                    <div class="emotion-text" id="current-emotion">--</div>
                    <div class="confidence" id="confidence">Ready to start</div>
                </div>
            </div>

            <div class="card">
                <h3>Session Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="label">Detections</div>
                        <div class="value" id="total-detections">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Duration</div>
                        <div class="value" id="duration">0:00</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Emotion Distribution</h3>
                <canvas id="emotionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    let sessionActive = false;
    let updateInterval = null;
    let chart = null;
    let sessionStartTime = null;

    // ‚úÖ FIX: store actual backend start_time reference if returned
    let backendStartTime = null;

    const ctx = document.getElementById('emotionChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Angry', 'Disgust', 'Fear', 'Happy', 'Sad', 'Surprise', 'Neutral'],
            datasets: [{
                label: 'Percentage (%)',
                data: [0, 0, 0, 0, 0, 0, 0],
                backgroundColor: ['#ef4444','#84cc16','#8b5cf6','#fbbf24','#3b82f6','#f97316','#6b7280']
            }]
        },
        options: {responsive:true,scales:{y:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}}
    });

    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alert-container');
        alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        document.querySelector('.alert').style.display = 'block';
        setTimeout(() => { document.querySelector('.alert').style.display = 'none'; }, 5000);
    }

    async function startSession() {
        try {
            const response = await fetch('/start_session', {method: 'POST'});
            const data = await response.json();

            if (data.status === 'success') {
                sessionActive = true;
                backendStartTime = new Date(); // ‚úÖ temporarily use now, backend ref possible
                sessionStartTime = Date.now();
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;

                const statusIndicator = document.getElementById('status-indicator');
                statusIndicator.className = 'status-indicator recording';
                statusIndicator.innerHTML = '<span class="status-dot"></span> Recording';

                updateInterval = setInterval(updateStats, 1000);
                showAlert('‚úÖ Session started successfully! Your emotions are being monitored.', 'success');
            }
        } catch (error) {
            console.error('Error starting session:', error);
            showAlert('‚ùå Failed to start session. Please try again.', 'info');
        }
    }

    async function stopSession() {
        try {
            const response = await fetch('/stop_session', {method: 'POST'});
            const data = await response.json();

            if (data.status === 'success') {
                sessionActive = false;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;

                const statusIndicator = document.getElementById('status-indicator');
                statusIndicator.className = 'status-indicator stopped';
                statusIndicator.innerHTML = '<span class="status-dot"></span> Not Recording';

                clearInterval(updateInterval);
                showAlert(
                    `‚úÖ Session completed!<br>
                    üìä Total emotions detected: ${data.total_emotions}<br>
                    ü§ñ AI Summary generated<br>
                    <a href="/my_sessions" style="color: inherit; text-decoration: underline;">View your session history ‚Üí</a>`,
                    'success'
                );
            }
        } catch (error) {
            console.error('Error stopping session:', error);
            showAlert('‚ùå Failed to stop session. Please try again.', 'info');
        }
    }

    async function updateStats() {
        try {
            // ‚úÖ FIX: backend-synced timer
            if (backendStartTime) {
                const diff = Math.floor((Date.now() - backendStartTime.getTime()) / 1000);
                const mins = Math.floor(diff / 60);
                const secs = diff % 60;
                document.getElementById('duration').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Current emotion
            const emotionResponse = await fetch('/current_emotion');
            const emotionData = await emotionResponse.json();
            if (emotionData.emotion && emotionData.emotion !== 'None') {
                document.getElementById('current-emotion').textContent = emotionData.emotion;
                document.getElementById('confidence').textContent = `Confidence: ${(emotionData.confidence * 100).toFixed(1)}%`;
            }

            // Stats update
            const statsResponse = await fetch('/session_stats');
            const statsData = await statsResponse.json();
            if (!statsData.error) {
                document.getElementById('total-detections').textContent = statsData.total_detections;

                const p = statsData.emotion_percentages;
                chart.data.datasets[0].data = [
                    p['Angry']||0, p['Disgust']||0, p['Fear']||0,
                    p['Happy']||0, p['Sad']||0, p['Surprise']||0, p['Neutral']||0
                ];
                chart.update();
            }
        } catch (error) { console.error('Error updating stats:', error); }
    }

    // Preview even when idle
    setInterval(async () => {
        if (!sessionActive) {
            try {
                const res = await fetch('/current_emotion');
                const d = await res.json();
                if (d.emotion && d.emotion !== 'None') {
                    document.getElementById('current-emotion').textContent = d.emotion;
                    document.getElementById('confidence').textContent = `Preview: ${(d.confidence * 100).toFixed(1)}%`;
                }
            } catch {}
        }
    }, 2000);
</script>
</body>
</html>
